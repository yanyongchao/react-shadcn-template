# 变更提案：打通菜单配置与 React 路由的联动

## 变更概述

当前项目中的菜单系统（`MEMU_CONFIG`）和 React Router 是独立配置的，导致以下问题：
1. 需要手动维护两套配置（路由配置和菜单配置）
2. 菜单点击没有自动导航功能
3. 路由变化时菜单高亮不会自动更新
4. 状态管理分散，难以维护

本变更将实现菜单与路由的深度联动，提供统一的导航体验。

## 为什么（Why）

### 业务价值

1. **提升用户体验**：实现菜单点击即导航的直观交互，符合用户对现代 Web 应用的期望
2. **减少维护成本**：建立菜单与路由的强关联，避免重复配置，降低维护复杂度
3. **提高代码一致性**：统一使用 React Router 状态作为单一数据源，避免状态同步问题

### 技术价值

1. **架构优化**：从分散状态管理改为集中状态管理，提高代码可维护性
2. **性能提升**：使用 React Router 原生 Hooks，避免不必要的状态更新和重渲染
3. **类型安全**：通过 TypeScript 类型系统确保菜单路径与路由路径的一致性

### 用户痛点

当前实现的菜单系统存在以下用户可感知的问题：
- 用户点击菜单后需要等待手动导航，体验不一致
- 直接通过 URL 访问页面时，菜单状态不同步
- 在页面间导航时，菜单高亮状态可能错误
- 开发者需要维护两套配置，容易出错

## 背景

### 当前架构

- **路由配置**：`src/router/index.tsx` + `src/router/modules/*.tsx`
- **菜单配置**：`src/router/config.tsx` 中的 `MEMU_CONFIG`
- **菜单组件**：`src/layouts/components/sidebar.tsx`
- **布局组件**：`src/layouts/index.tsx`

### 现有问题

1. **分离的配置**：
   - `ROUTE_PATHS` 定义路径常量
   - `MEMU_CONFIG` 定义菜单项（包含路径、标题、图标）
   - 两者需要手动保持同步

2. **缺少导航联动**：
   - `Sidebar` 组件的 `onMenuClick` 只更新本地 `activeKey` 状态
   - 没有调用 `navigate()` 进行路由导航

3. **缺少状态同步**：
   - `activeKey` 使用 `useState` 本地管理
   - 路由变化时菜单高亮不会自动更新
   - 用户直接通过 URL 访问时，菜单状态不同步

## 目标

实现菜单与路由的双向联动：
1. **菜单点击 → 自动导航**：点击菜单项时自动跳转到对应路由
2. **路由变化 → 自动高亮**：路由变化时菜单项自动高亮对应项
3. **配置统一**：建立菜单配置与路由配置的强关联，减少重复维护
4. **嵌套菜单支持**：支持多级菜单与嵌套路由的联动

## 成功标准

- [ ] 点击菜单项时自动导航到对应路由
- [ ] 路由变化时菜单自动高亮当前页面
- [ ] 支持嵌套菜单的联动（父级菜单自动展开，子项高亮）
- [ ] 删除重复的本地状态管理，统一由路由驱动
- [ ] 保持现有的折叠/展开功能不变
- [ ] 保持现有的响应式布局不变

## 影响范围

### 修改的文件

1. **核心改动**：
   - `src/layouts/index.tsx` - 修改状态管理，使用路由状态
   - `src/layouts/components/sidebar.tsx` - 添加导航功能
   - `src/router/config.tsx` - 可能需要调整类型定义

2. **测试文件**（如需要）：
   - 添加路由联动测试用例

### 向后兼容性

- ✅ 保持现有 API 不变
- ✅ 保持现有 UI 行为不变（仅增加导航联动）
- ✅ 保持现有组件 props 接口不变
- ⚠️ 内部状态管理方式变更（从 useState 改为路由驱动）

## 风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 路由循环导航 | 高 | 低 | 确保菜单 key 和路由路径一致，避免 self-navigation |
| 嵌套菜单路径匹配错误 | 中 | 中 | 使用精确的路径匹配，考虑父级路径的特殊处理 |
| 性能影响 | 低 | 低 | 使用 useCallback 优化，使用正确的依赖项 |
| 移动端兼容性 | 低 | 低 | 保持现有移动端逻辑不变 |

## 替代方案

### 方案 1：从路由配置自动生成菜单（推荐）
- 优点：单一数据源，自动同步
- 缺点：需要重新设计路由模块的结构

### 方案 2：保持分离配置，增强联动
- 优点：改动最小，易于理解
- 缺点：仍需手动维护两套配置

### 方案 3：使用第三方库（如 react-router-config）
- 优点：成熟的解决方案
- 缺点：增加依赖，需要学习成本

**选择方案 2**，因为它：
- 改动最小，风险最低
- 保持现有代码结构
- 易于实现和测试
- 符合当前项目需求

## 时间估算

- **设计**：0.5 小时
- **实现**：2 小时
- **测试**：1 小时
- **总计**：约 3.5 小时

## 验收标准

1. 功能测试
   - [ ] 点击每个菜单项都能正确导航
   - [ ] 直接访问 URL 时菜单正确高亮
   - [ ] 刷新页面后菜单状态保持
   - [ ] 浏览器前进/后退按钮正常工作
   - [ ] 嵌套菜单的展开/高亮正确

2. 回归测试
   - [ ] 侧边栏折叠/展开功能正常
   - [ ] 移动端菜单开关正常
   - [ ] 主题切换正常
   - [ ] 所有页面正常加载

3. 代码质量
   - [ ] 通过 ESLint 检查
   - [ ] 通过 TypeScript 类型检查
   - [ ] 代码格式化符合规范

## 相关资源

- [React Router useNavigate 文档](https://reactrouter.com/en/main/hooks/use-navigate)
- [React Router useLocation 文档](https://reactrouter.com/en/main/hooks/use-location)
- [React Router useMatches 文档](https://reactrouter.com/en/main/hooks/use-matches)

---

**创建时间**：2025-12-10
**创建者**：Claude Code
**状态**：待审核
